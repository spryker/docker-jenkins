name: CI/CD - Local Compare Only

on: [push]

jobs:
  compare-images:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Jenkins 2.176 (Previous Image)
        run: |
          echo "ðŸ”¨ Building Jenkins 2.176 as previous image"
          docker build -f 2.176/Dockerfile -t jenkins:2.176 .

      - name: Build Jenkins 2.305 (Current Image)
        run: |
          echo "ðŸ”¨ Building Jenkins 2.305 as current image"
          docker build -f 2.305/Dockerfile -t jenkins:2.305 .

      - name: Generate current image report
        run: |
          echo "ðŸ“¦ Generating current image report (2.305)"
          bash .github/compare-images.sh jenkins:2.305 > current-image-report.txt || true
          cat current-image-report.txt

      - name: Generate previous image report
        run: |
          echo "ðŸ“¦ Generating previous image report (2.176)"
          bash .github/compare-images.sh jenkins:2.176 > previous-image-report.txt || true
          cat previous-image-report.txt

      - name: Run the diff and format output
        run: |
          echo "ðŸ“„ === Previous Image Report (2.176) ==="
          cat previous-image-report.txt
          
          echo -e "\nðŸ“„ === Current Image Report (2.305) ==="
          cat current-image-report.txt
          
          echo -e "\nðŸ” Running diff..."
          bash .github/format-output.sh
          
          echo -e "\nðŸ“‹ === Diff Output ==="
          cat diff-output.txt

      - name: Fetch Job ID
        id: fetch_job_id
        if: ${{ env.DIFF_OUTPUT != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          JOBS_JSON=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs")
          echo "$JOBS_JSON" > jobs-response.json
          cat jobs-response.json
          JOB_ID=$(echo "$JOBS_JSON" | jq -r '.jobs[0].id')
          echo "Extracted Job ID: $JOB_ID"
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        if: ${{ env.DIFF_OUTPUT != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    {
                      "title": "New version of 2.305 has been published",
                      "value": "You can check the:\n- *Manifest*: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ steps.fetch_job_id.outputs.job_id }}#step:9:1|View Manifest>\n- *Diff*: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ steps.fetch_job_id.outputs.job_id }}#step:11:7|View Diff>\n\nThis version was built out of <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>.",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.WEBHOOK_CE_RELEASE_IMAGES_JENKINS }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
